@page
@model Nexy.Pages.FeedModel
@{
Layout = "_Layout";
}

<div class="container">
    <div class="feed">
        @if (!User.Identity.IsAuthenticated)
        {
        <div class="feed__notice">
            NSFW content is only available to authorized users. <a href="/Identity/Account/Login">Log in</a> to view.
        </div>
        }
        <div id="post-container" class="space-y-4">
            <partial name="_FeedPostListPartial" model="Model.Posts" />
        </div>
        <button id="load-more" class="load-more pulse"
                style="display: block; margin: 1rem auto; padding: 1rem 2rem; font-size: 1.25rem; cursor: pointer;">
            Load More
        </button>
    </div>

    <div class="modal" id="imageModal">
        <img class="modal__image" id="modalImage" src="" alt="Full image" />
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Modal for images
        const images = document.querySelectorAll('.feed-post__image');
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        images.forEach(image => {
            image.addEventListener('click', function () {
                modalImage.src = this.dataset.fullsrc;
                modal.classList.add('active');
            });
        });

        modal.addEventListener('click', function () {
            modal.classList.remove('active');
        });

        // Load More
        let loaded = @Model.LoadedCount;
        document.getElementById("load-more").addEventListener("click", function () {
            fetch(`/Feed?handler=LoadMore&skip=${loaded}`)
                .then(response => response.text())
                .then(html => {
                    const container = document.getElementById("post-container");
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = html;
                    Array.from(tempDiv.children).forEach(child => {
                        child.classList.add("fade-in");
                        container.appendChild(child);
                    });
                    loaded += 10;

                    // Rebind image click events
                    const newImages = container.querySelectorAll('.feed-post__image');
                    newImages.forEach(image => {
                        image.addEventListener('click', function () {
                            modalImage.src = this.dataset.fullsrc;
                            modal.classList.add('active');
                        });
                    });
                });
        });
    });
</script>
}